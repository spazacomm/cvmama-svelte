function _arrayLikeToArray(n,e){(null==e||e>n.length)&&(e=n.length);for(var r=0,t=new Array(e);r<e;r++)t[r]=n[r];return t}function _arrayWithHoles(n){if(Array.isArray(n))return n}function asyncGeneratorStep(n,e,r,t,o,i,a){try{var c=n[i](a),u=c.value}catch(n){return void r(n)}c.done?e(u):Promise.resolve(u).then(t,o)}function _asyncToGenerator(n){return function(){var e=this,r=arguments;return new Promise((function(t,o){var i=n.apply(e,r);function a(n){asyncGeneratorStep(i,t,o,a,c,"next",n)}function c(n){asyncGeneratorStep(i,t,o,a,c,"throw",n)}a(void 0)}))}}function _iterableToArrayLimit(n,e){var r=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null!=r){var t,o,i=[],a=!0,c=!1;try{for(r=r.call(n);!(a=(t=r.next()).done)&&(i.push(t.value),!e||i.length!==e);a=!0);}catch(n){c=!0,o=n}finally{try{a||null==r.return||r.return()}finally{if(c)throw o}}return i}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _slicedToArray(n,e){return _arrayWithHoles(n)||_iterableToArrayLimit(n,e)||_unsupportedIterableToArray(n,e)||_nonIterableRest()}function _unsupportedIterableToArray(n,e){if(n){if("string"==typeof n)return _arrayLikeToArray(n,e);var r=Object.prototype.toString.call(n).slice(8,-1);return"Object"===r&&n.constructor&&(r=n.constructor.name),"Map"===r||"Set"===r?Array.from(r):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(n,e):void 0}}var __generator=this&&this.__generator||function(n,e){var r,t,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,t&&(o=2&i[0]?t.return:i[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,i[1])).done)return o;switch(t=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,t=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(n,a)}catch(n){i=[6,n],t=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}};function BHSocket(){var n=function(){return l},e=function(){l=!1,"client"===page_info.user_type&&(f.unsubscribe(),o("encrypted","client_disconnected",{bye:"bye"})),d.unsubscribe()},r=function(n){n.user_ids.forEach((function(n){o("encrypted","send_your_information_to_counselor",{send_your_information_to_counselor:!0},n)}))},t=function(n){},o=function(n,e,r,t){r=r||{},t=t||null;try{$.post("/api/pusher-trigger",{channel:s(n,t),event:e,data:r,csrf_token:page_info.csrf_token})}catch(n){void 0!==window.logger&&window.logger.error(n)}},i=function(e,r,t){var o;n()?null===(o=a(e))||void 0===o||o.bind(r,t):_.push([e,r,t])},a=function(n){switch(n){case"encrypted":default:return d;case"groupEncrypted":return f}},c=function(){(f=p.subscribe(v("private-encrypted-to_client_g-".concat(page_info.counselor_id)))).bind("pusher:subscription_error",(function(n){if(void 0!==window.logger){var e=n.type,r=void 0===e?"":e,t=n.error,o=void 0===t?"":t,i=n.status,a=void 0===i?"":i;window.logger.warning("Failed to sub to client encrypted group channel ".concat(r," - ").concat(a," - ").concat(o))}})),(d=p.subscribe(v("private-encrypted-to_client_p-".concat(page_info.user_id)))).bind("pusher:subscription_error",(function(n){if(void 0!==window.logger){var e=n.type,r=void 0===e?"":e,t=n.error,o=void 0===t?"":t,i=n.status,a=void 0===i?"":i;window.logger.warning("Failed to sub to client encrypted channel ".concat(r," - ").concat(a," - ").concat(o))}}))},u=function(){p.user.watchlist.bind("online",r),p.user.watchlist.bind("offline",t),(d=p.subscribe(v("private-encrypted-to_counselor_p-".concat(page_info.user_id)))).bind("pusher:subscription_error",(function(n){if(void 0!==window.logger){var e=n.type,r=void 0===e?"":e,t=n.error,o=void 0===t?"":t,i=n.status,a=void 0===i?"":i;window.logger.warning("Failed to sub to counselor encrypted channel ".concat(r," - ").concat(a," - ").concat(o))}}))},s=function(n,e){var r="";if("client"===page_info.user_type&&page_info.counselor_id&&"encrypted"===n&&(r="private-encrypted-to_counselor_p-".concat(page_info.counselor_id)),"counselor"===page_info.user_type){var t;if("encrypted"===n&&e)e=parseInt(null===(t=e.toString().match(/(\d+)-/))||void 0===t?void 0:t[1])||null,r="private-encrypted-to_client_p-".concat(e);"groupEncrypted"===n&&(r="private-encrypted-to_client_g-".concat(page_info.user_id))}return v(r)},l=!1,p=null,d=null,f=null,_=[];function y(){return g.apply(this,arguments)}function g(){return(g=_asyncToGenerator((function(){var n,e,r,t,a,s,p,d,f,y;return __generator(this,(function(g){switch(g.label){case 0:return l=!0,"client"!==page_info.user_type?[3,1]:(c(),o("encrypted","client_connected",{id:page_info.client_id,nick_name:page_info.client_nickname,site_name:page_info.product_code_name}),[3,4]);case 1:return"counselor"!==page_info.user_type?[3,2]:(u(),[3,4]);case 2:return page_info.manage_user?[4,h()]:[3,4];case 3:g.sent(),g.label=4;case 4:n=!0,e=!1,r=void 0;try{for(t=_[Symbol.iterator]();!(n=(a=t.next()).done);n=!0)s=_slicedToArray(a.value,3),p=s[0],d=s[1],f=s[2],i(p,d,f)}catch(n){e=!0,r=n}finally{try{n||null==t.return||t.return()}finally{if(e)throw r}}return _.length=0,y=new Event("pusherConnected"),window.dispatchEvent(y),[2]}}))}))).apply(this,arguments)}function h(){return b.apply(this,arguments)}function b(){return(b=_asyncToGenerator((function(){var n,e,r,t,o,i;return __generator(this,(function(a){switch(a.label){case 0:return n=(new TextEncoder).encode(page_info.manage_user),[4,crypto.subtle.digest("SHA-256",n)];case 1:return e=a.sent(),r=Array.from(new Uint8Array(e)),t=r.map((function(n){return n.toString(16).padStart(2,"0")})).join(""),o=t.slice(0,10),i=parseInt(o,16),(d=p.subscribe(v("private-encrypted-to_manage_user_p-".concat(i)))).bind("pusher:subscription_error",(function(n){if(void 0!==window.logger){var e=n.type,r=void 0===e?"":e,t=n.error,o=void 0===t?"":t,i=n.status,a=void 0===i?"":i;window.logger.warning("Failed to sub to manage encrypted channel ".concat(r," - ").concat(a," - ").concat(o))}})),[2]}}))}))).apply(this,arguments)}var v=function(n){var e=n;return page_info.is_non_production_cloud&&(e+="-".concat(page_info.subdomain)),page_info.is_development_local&&(e+="-".concat(page_info.environment_name)),e};return{connect:function(){if(!n())try{(p=new Pusher(page_info.socket.api_key,{cluster:page_info.socket.cluster,userAuthentication:{transport:"ajax",endpoint:"/api/pusher-user-authentication",params:{csrf_token:page_info.csrf_token}},channelAuthorization:{transport:"ajax",endpoint:"/api/pusher-user-authorization",params:{csrf_token:page_info.csrf_token}}})).connection.bind("connected",y),p.connection.bind("disconnected",e),p.connection.bind("error",(function(n){return console.log(n)})),p.signin()}catch(n){console.error("Failed to connect to pusher",n)}},isConnected:n,emit:o,on:i,off:function(n,e,r){a(n).unbind(e,r)}}}window.bh_socket=BHSocket();var $pusher_script=$("#pusher-script");$pusher_script.on("load",(function(){bh_socket.connect()})),$pusher_script.attr("src",page_info.pusher_script);
//# sourceMappingURL=socket.js.map
